<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SAT Question Bank — Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- silence favicon 404 -->
  <link rel="icon" href="data:,">

  <style>
    :root { --bg:#0b1020; --card:#121a2c; --text:#e8edf7; --muted:#9fb0d0; --accent:#5ea0ff; }
    html,body { margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header { padding:18px 20px; border-bottom:1px solid #20304f; display:flex; gap:12px; align-items:end; flex-wrap:wrap; }
    header h1 { margin:0 16px 0 0; font-size:20px; font-weight:700; }
    label { font-size:14px; color:var(--muted); margin-right:10px; }
    select,input,button { background:#0f1726; color:var(--text); border:1px solid #253454; border-radius:8px; padding:8px 10px; font-size:14px; }
    button { cursor:pointer; }
    button.primary { background:var(--accent); color:#081120; border:none; }
    .wrap { padding:20px; max-width:980px; margin:0 auto; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; }
    .chips { display:flex; gap:6px; }
    .chip { padding:4px 8px; border:1px solid #2a3a5c; border-radius:999px; cursor:pointer; user-select:none; }
    .chip.active { background:#1d2944; border-color:#3b5aa0; color:#d9e8ff; }
    .grid { display:grid; gap:14px; }
    .card { background:var(--card); border:1px solid #20304f; border-radius:14px; padding:16px; }
    .id { font-size:12px; color:var(--muted); }
    .stem { font-size:16px; line-height:1.45; white-space:pre-wrap; }
    .ans { margin-top:10px; font-size:14px; color:#b5c7ea; }
    details { margin-top:10px; }
    footer { padding:18px 20px 40px; color:var(--muted); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer { flex:1; }
    .muted { color:var(--muted); }
    .hint { font-size:12px; color:#9fb0d0; margin-left:6px; }
  </style>

  <!-- KaTeX (optional) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
</head>
<body>

<header>
  <h1>SAT Question Bank — Viewer</h1>
  <div class="filters">
    <label>Mode
      <select id="mode">
        <option value="random">Random (seeded)</option>
        <option value="ordered">In order</option>
      </select>
    </label>

    <label>Bank
      <select id="bank">
        <option value="HOA">HOA</option>
        <option value="PAM">PAM</option>
        <option value="PSDA">PSDA</option>
        <option value="GEOT">GEOT</option>
        <option value="ALL">All</option>
      </select>
    </label>

    <div id="randomControls" class="row">
      <label>Count <input id="count" type="number" value="10" min="1" style="width:80px"></label>
      <label>Seed <input id="seed" type="text" placeholder="e.g. demo-2025-09-28" style="width:180px"></label>
    </div>

    <div id="orderedControls" class="row" style="display:none">
      <label>Start index <input id="start" type="number" value="0" min="0" style="width:100px"></label>
      <label>Per page <input id="per" type="number" value="10" min="1" style="width:80px"></label>
      <span class="hint">Uses file order (stable); seeded variants by id.</span>
    </div>

    <div class="row">
      <span class="muted">Difficulty:</span>
      <div id="diffs" class="chips" role="group" aria-label="difficulty">
        <span class="chip active" data-d="E" tabindex="0">E</span>
        <span class="chip active" data-d="M" tabindex="0">M</span>
        <span class="chip active" data-d="H" tabindex="0">H</span>
      </div>
    </div>

    <button id="go" class="primary">Generate</button>
    <button id="share">Copy link</button>
  </div>
</header>

<main class="wrap">
  <div id="status" class="muted"></div>
  <div id="list" class="grid"></div>
</main>

<footer class="wrap">
  <div class="muted">
    Tip: Random mode is reproducible with the same seed. Ordered mode seeds each item as <code>id</code>
    so variants are stable; use “Re-roll” to re-generate a variant of the same template.
  </div>
</footer>

<script>
/* surface script errors in the UI */
window.addEventListener('error', e => {
  const s = document.getElementById('status');
  if (s) s.textContent = '⚠️ Script error: ' + (e.error?.message || e.message || 'unknown');
});

/*** deterministic RNG (no deps) ***/
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=Math.imul(h1^k,597399067);h2=Math.imul(h2^k,2869860233);h3=Math.imul(h3^k,951274213);h4=Math.imul(h4^k,2716044179);}h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);return[(h1^h2^h3^h4)>>>0];}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
function makeRng(seed){const[s]=cyrb128(String(seed));return mulberry32(s);}

/*** ---------- global display policy ---------- ***/
const GLOBAL_FORMAT = {
  preferFraction: true,    // try to show simple fraction for non-terminating decimals
  maxDecimals: 3,          // otherwise round to ≤ 3 dp
  fractionMaxDen: 200,     // cap denominator we consider “simple”
  fractionTol: 1e-9
};

/*** ---------- fraction + rounding helpers ---------- ***/
function isNumber(x){ return typeof x === "number" && Number.isFinite(x); }

// continued-fraction rational approximation
function toFraction(x, maxDen=200, tol=1e-9){
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x);
  if (!isFinite(x)) return null;
  let h1=1, h0=0, k1=0, k0=1, b=x, a=Math.floor(b);
  let h=a*h1+h0, k=a*k1+k0;
  let prevErr = Math.abs(x - h/k);
  while (k <= maxDen) {
    if (Math.abs(x - h/k) <= tol) break;
    b = 1/(b - a);
    a = Math.floor(b);
    const h2 = a*h + h1, k2 = a*k + k1;
    h1=h; k1=k; h=h2; k=k2;
    const err = Math.abs(x - h/k);
    if (err > prevErr) break;
    prevErr = err;
  }
  return { n: sign*h, d: k, err: Math.abs(sign*h/k - sign*x) };
}

// does x terminate within up to maxPlaces decimals?
function terminatesWithin(x, maxPlaces){
  const eps = 1e-10;
  let t = x;
  for (let k=0; k<=maxPlaces; k++){
    if (Math.abs(t - Math.round(t)) < eps) return true;
    t *= 10;
  }
  return false;
}

function formatDisplay(x, tmplFmt=null){
  if (!isNumber(x)) return x;

  // template-level override
  if (tmplFmt) {
    if (tmplFmt.fixed != null) return Number(x.toFixed(+tmplFmt.fixed));
    if (tmplFmt.round != null) { const p = Math.pow(10, +tmplFmt.round); return Math.round(x*p)/p; }
  }

  const { preferFraction, maxDecimals, fractionMaxDen, fractionTol } = GLOBAL_FORMAT;

  if (terminatesWithin(x, maxDecimals)) return Number(x.toFixed(maxDecimals));

  if (preferFraction) {
    const frac = toFraction(x, fractionMaxDen, fractionTol);
    if (frac && frac.d > 1 && frac.err <= fractionTol) {
      const g = (a,b)=>b?g(b,a%b):Math.abs(a);
      const gg = g(Math.abs(frac.n), frac.d);
      return `${(frac.n/gg)}\/${(frac.d/gg)}`;
    }
  }
  return Number(x.toFixed(maxDecimals));
}

/*** ---------- generator helpers ---------- ***/
function pick(spec,rnd){
  if(!spec)throw new Error("Bad param spec");
  if(Array.isArray(spec.values)){
    const a=spec.values; return a[Math.floor(rnd()*a.length)];
  }
  const min=spec.min??0, max=spec.max??min, exclude=new Set(spec.exclude||[]);
  const isInt=Number.isInteger(min)&&Number.isInteger(max);
  for(let i=0;i<400;i++){
    const v=isInt?Math.floor(min+rnd()*(max-min+1)):(min+rnd()*(max-min));
    if(!exclude.has(v))return v;
  }
  throw new Error("Could not sample param (too restrictive).");
}
function renderStem(stem,vars){
  return String(stem||"").replace(/\{\{\s*([a-zA-Z_]\w*)\s*\}\}/g,(_,k)=>(k in vars?String(vars[k]):`{{${k}}}`));
}
function evalExpr(expr,scope){
  const keys=["Math","Number",...Object.keys(scope)], vals=[Math,Number,...Object.values(scope)];
  if(typeof expr!=="string")return expr;
  if (/[;{}\[\]]|new|class|function|=>|import|export|process|global|window/i.test(expr)) throw new Error("Unsafe expression: "+expr);
  return Function(...keys,'"use strict"; return ('+expr+');')(...vals);
}
function safeEvalOrLiteral(expr,scope){
  if(typeof expr!=="string")return expr;
  const hasOp=/[+\-*/^()=<>]|Math\./.test(expr);
  try{ if(hasOp) return evalExpr(expr,scope); if(expr in scope) return scope[expr]; return expr; }
  catch{ return expr; }
}

/*** ---------- generateItem with fraction/rounding + auto-pad ---------- ***/
function generateItem(template, seed = "demo") {
  const rnd = makeRng(seed);
  const { stem, params = {}, derived = {}, constraints = [], answer, distractors = [] } = template;
  const tmplFmt = template.format || template.display || null;

  const MAX_TRIES = 250;
  for (let attempt = 0; attempt < MAX_TRIES; attempt++) {
    const P = {};
    for (const [k, spec] of Object.entries(params)) P[k] = pick(spec, rnd);

    const D = {};
    let okDer = true;
    for (const [k, expr] of Object.entries(derived)) {
      try { D[k] = evalExpr(expr, { ...P, ...D }); } catch { okDer = false; break; }
    }
    if (!okDer) continue;

    let ok = true;
    for (const c of constraints) {
      try { if (!evalExpr(c, { ...P, ...D })) { ok = false; break; } }
      catch { ok = false; break; }
    }
    if (!ok) continue;

    const ansRaw = safeEvalOrLiteral(answer, { ...P, ...D });
    const optsRaw = [];
    for (const d of distractors) {
      const v = safeEvalOrLiteral(d, { ...P, ...D, ans: ansRaw });
      if (String(v) !== String(ansRaw)) optsRaw.push(v);
    }

    const ansDisp = formatDisplay(ansRaw, tmplFmt);
    const optsDisp = [];
    const used = new Set([String(ansDisp)]);
    for (const v of optsRaw) {
      const f = formatDisplay(v, tmplFmt);
      if (!used.has(String(f))) { optsDisp.push(f); used.add(String(f)); }
    }

    // Auto-pad to 4 options when answer numeric
    if (isNumber(ansRaw) && optsDisp.length < 3) {
      const padRng = makeRng(seed + ":auto");
      const mag = Math.max(1e-6, Math.pow(10, Math.floor(Math.log10(Math.abs(ansRaw) || 1)) - 1));
      const candidates = [ ansRaw + mag, ansRaw - mag, Math.floor(ansRaw), Math.ceil(ansRaw), ansRaw * 1.1, ansRaw * 0.9 ];
      for (const c of candidates) {
        const f = formatDisplay(c, tmplFmt);
        if (!used.has(String(f))) { optsDisp.push(f); used.add(String(f)); if (optsDisp.length >= 3) break; }
      }
      while (optsDisp.length < 3) {
        const delta = (0.5 + padRng()) * mag * (padRng() < 0.5 ? -1 : 1);
        const f = formatDisplay(ansRaw + delta, tmplFmt);
        if (!used.has(String(f))) { optsDisp.push(f); used.add(String(f)); }
      }
    }

    return {
      stem: renderStem(stem, { ...P, ...D }),
      params: P,
      derived: D,
      answer: ansDisp,
      distractors: optsDisp.slice(0, 3)
    };
  }
  throw new Error("Constraint not satisfiable after multiple attempts");
}

/*** ---------- data + UI ---------- ***/
const FILES = {
  HOA: "data/MASTER_HOA_SAT.json",
  PAM: "data/MASTER_PAM_SAT.json",
  PSDA: "data/MASTER_PSDA_SAT.json",
  GEOT: "data/MASTER_GEOT_SAT.json"
};
const els = {
  mode: document.getElementById("mode"),
  bank: document.getElementById("bank"),
  count: document.getElementById("count"),
  seed: document.getElementById("seed"),
  start: document.getElementById("start"),
  per: document.getElementById("per"),
  randomControls: document.getElementById("randomControls"),
  orderedControls: document.getElementById("orderedControls"),
  diffs: document.getElementById("diffs"),
  go: document.getElementById("go"),
  share: document.getElementById("share"),
  list: document.getElementById("list"),
  status: document.getElementById("status")
};

function seededShuffle(arr, seed){ const rnd = makeRng(seed); const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j = Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function getActiveDiffs(){ return Array.from(els.diffs.querySelectorAll(".chip.active")).map(x => x.dataset.d); }
function toggleChip(e){ const chip = e.target.closest(".chip"); if (chip) chip.classList.toggle("active"); }
els.diffs.addEventListener("click", toggleChip);
els.diffs.addEventListener("keydown", e => { if (e.key===" "||e.key==="Enter"){ e.preventDefault(); toggleChip(e); } });

els.mode.addEventListener("change", () => {
  const ordered = els.mode.value === "ordered";
  els.randomControls.style.display = ordered ? "none" : "flex";
  els.orderedControls.style.display = ordered ? "flex" : "none";
});

function q(key, fallback=null){ return new URLSearchParams(location.search).get(key) ?? fallback; }
function syncFromQuery(){
  els.mode.value = q("mode","random");
  els.bank.value = q("bank","HOA");
  els.count.value = +q("n","10");
  els.seed.value = q("seed","");
  els.start.value = +q("start","0");
  els.per.value = +q("per","10");
  const dif = (q("d","EMH")||"").split("").filter(Boolean);
  els.diffs.querySelectorAll(".chip").forEach(c=> c.classList.toggle("active", dif.includes(c.dataset.d)));
  els.mode.dispatchEvent(new Event("change"));
}
function updateQuery(params){
  const u = new URL(location.href);
  for (const [k,v] of Object.entries(params)) u.searchParams.set(k, v);
  history.replaceState(null,"",u.toString());
}

async function loadBanks(which){
  const names = which==="ALL" ? Object.keys(FILES) : [which];
  const all = [];
  for (const n of names){
    const url = FILES[n];
    els.status.textContent = `Loading ${n}…`;
    try{
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
      all.push(await resp.json());
    }catch(err){
      throw new Error(`Failed to load ${n} from ${url}: ${err.message || err}`);
    }
  }
  return all.reduce((acc,cur)=>acc.concat(cur),[]);
}

function renderKaTeX(container){
  if (window.renderMathInElement) {
    window.renderMathInElement(container, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "\\[", right: "\\]", display: true},
        {left: "\\(", right: "\\)", display: false},
        {left: "$", right: "$", display: false}
      ],
      throwOnError: false
    });
  }
}

async function generate(){
  els.status.textContent = "Loading…";
  const mode  = els.mode.value;
  const bank  = els.bank.value;
  const diffs = getActiveDiffs();
  const n     = Math.max(1, parseInt(els.count.value || "10", 10));
  const seed  = els.seed.value || new Date().toISOString().slice(0,10);
  const start = Math.max(0, parseInt(els.start.value || "0", 10));
  const per   = Math.max(1, parseInt(els.per.value || "10", 10));

  updateQuery({mode, bank, n, seed, start, per, d: diffs.join("")});

  let items;
  try{
    items = (await loadBanks(bank)).filter(it => diffs.includes(it.difficulty || "M"));
  }catch(e){
    els.list.innerHTML = "";
    els.status.textContent = `⚠️ ${e.message}`;
    return;
  }

  if (mode === "ordered") {
    items.sort((a,b) => (a.domain||"").localeCompare(b.domain||"")
                      || (a.subtopic||"").localeCompare(b.subtopic||"")
                      || (a.id||"").localeCompare(b.id||""));
    items = items.slice(start, start + per);
  } else {
    items = seededShuffle(items, seed + ":list").slice(0, Math.min(n, items.length));
  }

  els.list.innerHTML = "";
  let ok=0, fail=0;

  for (const it of items) {
    const id = it.id || "(no-id)";
    // include hidden seed in ordered mode so Re-roll changes variant
    const variantSeed = (mode === "ordered")
      ? (id + ":" + (els.seed.value || "0"))
      : (seed + ":" + id);

    let gen, err = null;
    try{ gen = generateItem(it.template, variantSeed); ok++; }
    catch(e){ err = String(e.message || e); fail++; }

    const card = document.createElement("div");
    card.className = "card";

    const stem = err
      ? `<div class="stem"><strong>⚠️ ${id}</strong><br>${err}</div>`
      : `<div class="stem">${gen.stem}</div>`;

    const opts = (!err && gen.distractors && gen.distractors.length)
      ? `<div class="muted" style="margin-top:8px">Choices (shuffled locally)</div>
         <ul>${seededShuffle([gen.answer, ...gen.distractors], variantSeed + ":opts").map(o=>`<li>${o}</li>`).join("")}</ul>`
      : "";

    const expl = (!err && it.template && it.template.explanation)
      ? `<details><summary>Explanation</summary><div class="ans">${it.template.explanation}</div></details>` : "";

    const rerollBtn = (!err) ? `<button class="reroll" data-id="${id}">Re-roll</button>` : "";

    card.innerHTML = `
      <div class="row">
        <div class="id">${id}</div>
        <div class="spacer"></div>
        ${rerollBtn}
      </div>
      ${stem}
      <div class="ans"><strong>Answer:</strong> ${err ? "—" : gen.answer}</div>
      ${opts}
      ${expl}
    `;
    els.list.appendChild(card);
  }

  els.status.textContent = `${ok} rendered, ${fail} failed. ${mode==="random" ? ('Seed: ' + seed) : ''}`;
  renderKaTeX(document.body);

  // Re-roll
  els.list.querySelectorAll("button.reroll").forEach(btn => {
    btn.addEventListener("click", () => {
      const bump = Math.floor(Math.random()*1e6);
      els.seed.value = (els.mode.value === "ordered") ? ('reroll-' + bump) : (els.seed.value || ('reroll-' + bump));
      generate();
    });
  });
}

document.getElementById("go").addEventListener("click", generate);
document.getElementById("share").addEventListener("click", () => {
  navigator.clipboard.writeText(location.href).then(()=>{
    els.status.textContent = "Link copied to clipboard.";
    setTimeout(()=> els.status.textContent = "", 1500);
  });
});

function syncFromQuery(){
  els.mode.value = q("mode","random");
  els.bank.value = q("bank","HOA");
  els.count.value = +q("n","10");
  els.seed.value = q("seed","");
  els.start.value = +q("start","0");
  els.per.value = +q("per","10");
  const dif = (q("d","EMH")||"").split("").filter(Boolean);
  els.diffs.querySelectorAll(".chip").forEach(c=> c.classList.toggle("active", dif.includes(c.dataset.d)));
  els.mode.dispatchEvent(new Event("change"));
}
function q(key, fallback=null){ return new URLSearchParams(location.search).get(key) ?? fallback; }

function init(){ syncFromQuery(); generate(); }
init();
</script>
</body>
</html>
