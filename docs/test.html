<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SAT Math — Adaptive Practice (2 Modules)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<style>
  :root{
    --cb-blue:#1f4db5; --cb-blue-600:#113a92; --cb-blue-100:#eaf0ff;
    --ink:#0b1020; --bg:#f7f9ff; --card:#ffffff; --muted:#66759a;
    --ok:#0a7c3b; --bad:#c4322b;
  }
  html,body{margin:0;height:100%; background:var(--bg); color:var(--ink); font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  header.topbar{background:var(--cb-blue); color:#fff; padding:10px 16px; display:flex; align-items:center; gap:16px; box-shadow:0 1px 0 var(--cb-blue-600) inset, 0 2px 8px rgba(0,0,0,.08); position:sticky; top:0; z-index:20;}
  .brand{font-weight:700}
  .pill{background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.35); padding:6px 10px; border-radius:999px; font-weight:600}
  .spacer{flex:1}
  .btn{background:#fff; color:var(--cb-blue); border:1px solid var(--cb-blue); font-weight:600; padding:8px 12px; border-radius:10px; cursor:pointer;}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  main{max-width:1050px; margin:16px auto; padding:0 16px 40px}
  .card{background:var(--card); border:1px solid #dfe6ff; border-radius:14px; padding:16px; box-shadow:0 3px 12px rgba(31,77,181,.08)}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .qnum{background:var(--cb-blue-100); color:var(--cb-blue); border:1px solid var(--cb-blue); padding:4px 8px; border-radius:10px; font-weight:700}
  .stem{font-size:18px; margin:10px 0 12px}
  .choices{display:grid; gap:10px; margin-top:8px}
  .choice{border:1px solid #cfe0ff; border-radius:12px; padding:12px; background:#fff; cursor:pointer; display:flex; align-items:center; gap:12px}
  .choice:hover{border-color:var(--cb-blue)}
  .choice input{accent-color:var(--cb-blue)}
  .nav{display:flex; gap:10px; justify-content:space-between; margin-top:16px}
  .tiny{font-size:13px; color:var(--muted)}
  .status{margin:10px 0; color:var(--muted)}
  .green{color:var(--ok)}
  .red{color:var(--bad)}
  .pop{position:fixed; right:20px; bottom:20px; width:520px; height:420px; background:#fff;
       border:1px solid #ccd6ff; border-radius:14px; box-shadow:0 20px 50px rgba(17,58,146,.28); z-index:99; display:none}
  .pop .head{user-select:none; cursor:move; height:42px; background:var(--cb-blue); color:#fff; border-radius:14px 14px 0 0;
             display:flex; align-items:center; justify-content:space-between; padding:0 12px;}
  .pop .body{height:calc(100% - 42px); background:#fff; border-radius:0 0 14px 14px; overflow:hidden}
  .pop .x{background:transparent; border:1px solid rgba(255,255,255,.75); color:#fff; border-radius:8px; padding:4px 8px; cursor:pointer}
  .ref-img{width:100%; height:100%; object-fit:contain; background:#fff}
  .calc-iframe{width:100%; height:100%; border:0}
  .dock{display:flex; gap:10px}
  .dock .btn{background:#fff; color:var(--cb-blue); border-color:#cfe0ff}
  .alert{padding:10px 12px; border-radius:10px; background:#fff8d6; border:1px solid #ffe487}
  .chip{padding:2px 8px;border-radius:999px;background:var(--cb-blue-100); border:1px solid #cfe0ff; color:#143b8d; font-weight:600}
  .dbg{margin-left:8px; background:#eef3ff; border:1px solid #cfe0ff; color:#113a92; padding:4px 8px; border-radius:999px; font-weight:600}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">Math Practice — 2 Module Adaptive</div>
  <div id="hdrModule" class="pill">Module 1</div>
  <div id="hdrTimer" class="pill">35:00</div>
  <div class="spacer"></div>
  <div class="dock">
    <button id="btnRef" class="btn">Reference</button>
    <button id="btnCalc" class="btn">Calculator</button>
  </div>
</header>

<main>
  <div id="status" class="status"></div>

  <div id="intro" class="card">
    <h2 style="margin:0 0 6px;">Welcome</h2>
    <p class="tiny">Two adaptive modules • 22 questions each • 35 minutes per module. A new random session seed is created
      every time you open this page (unless you include <code>?seed=</code> in the URL).</p>
    <div style="margin-top:10px">
      <!-- direct onclick wire-up (in addition to addEventListener later) -->
      <button id="btnStart" class="btn" onclick="beginModule1()">Start Module 1</button>
      <span id="seedEcho" class="tiny" style="margin-left:8px;"></span>
    </div>
  </div>

  <div id="qCard" class="card" style="display:none">
    <div class="row">
      <div id="qNum" class="qnum">Q 1</div>
      <div id="qDbg" class="dbg">ID —</div>
      <div class="spacer"></div>
    </div>
    <div id="qStem" class="stem">Loading…</div>
    <div id="qChoices" class="choices"></div>

    <div class="nav">
      <button id="btnPrev" class="btn">Back</button>
      <div class="spacer"></div>
      <button id="btnNext" class="btn">Next</button>
      <button id="btnSubmitModule" class="btn" style="display:none">Submit Module</button>
    </div>
  </div>

  <div id="summary" class="card" style="display:none"></div>
</main>

<!-- Pop-outs -->
<div id="popCalc" class="pop" aria-modal="true">
  <div class="head" data-drag="calc"><span>Desmos Calculator</span><button class="x" data-close="calc">✕</button></div>
  <div class="body">
    <iframe class="calc-iframe"
      src="https://www.desmos.com/test-mode?lang=en&mode=sat&embed"
      title="Desmos SAT Calculator"></iframe>
  </div>
</div>

<div id="popRef" class="pop" aria-modal="true" style="width:760px;height:520px; right:560px;">
  <div class="head" data-drag="ref"><span>Reference Sheet</span><button class="x" data-close="ref">✕</button></div>
  <div class="body" style="padding:8px; background:#fff">
    <img id="refImg" class="ref-img" alt="SAT Math Reference Sheet">
  </div>
</div>

<script>
/* ========= Global error & promise rejection → show in status ========= */
(function(){
  const show = (msg)=>{ const el=document.getElementById('status'); if(el) el.textContent=msg; };
  window.addEventListener('error', e=>show('⚠️ Script error: '+(e.error?.message||e.message||'unknown')));
  window.addEventListener('unhandledrejection', e=>show('⚠️ Promise error: '+(e.reason?.message||e.reason||'unknown')));
})();

/* ----------------------------- Config ------------------------------ */
const PREFIX = location.pathname.includes('/docs/') ? '..' : '.';
const FILES = {
  HOA: `${PREFIX}/data/CLEAN_HOA_SAT.json`,
  PAM: `${PREFIX}/data/CLEAN_PAM_SAT.json`,
  GEOT: `${PREFIX}/data/CLEAN_GEOT_SAT.json`,
  PSDA: `${PREFIX}/data/CLEAN_PSDA_SAT.json`,
};
const REFERENCE_IMG = `${PREFIX}/data/sat-reference.jpg`;

const BLUEPRINT = {
  M1:{E:7,M:10,H:5}, M2easy:{E:9,M:11,H:2}, M2hard:{E:3,M:12,H:7}
};
const BRANCH_THRESHOLD = 14;
const MODULE_TIME = 35*60;
const MAX_PER_TOPIC = 6;

/* -------------------------- RNG / helpers -------------------------- */
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=Math.imul(h1^k,597399067);h2=Math.imul(h2^k,2869860233);h3=Math.imul(h3^k,951274213);h4=Math.imul(h4^k,2716044179);}h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);return[(h1^h2^h3^h4)>>>0];}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
function makeRng(seed){const[s]=cyrb128(String(seed));return mulberry32(s);}
function seededShuffle(arr, seed){const rnd=makeRng(seed);const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function pick(spec,rnd){ if(!spec) throw new Error('Bad param spec');
  if(Array.isArray(spec.values)){ const a=spec.values; return a[Math.floor(rnd()*a.length)]; }
  const min=spec.min??0, max=spec.max??min, exclude=new Set(spec.exclude||[]);
  const isInt=Number.isInteger(min)&&Number.isInteger(max);
  for(let i=0;i<400;i++){ const v=isInt?Math.floor(min+rnd()*(max-min+1)):(min+rnd()*(max-min)); if(!exclude.has(v)) return v; }
  throw new Error('Could not sample param (too restrictive).');}
function renderStem(stem,vars){return String(stem||'').replace(/\{\{\s*([a-zA-Z_]\w*)\s*\}\}/g,(_,k)=>(k in vars?String(vars[k]):`{{${k}}}`));}
function evalExpr(expr,scope){
  const keys=['Math','Number',...Object.keys(scope)], vals=[Math,Number,...Object.values(scope)];
  if(typeof expr!=='string') return expr;
  if(/[;{}\[\]]|new|class|function|=>|import|export|process|global|window/i.test(expr)) throw new Error('Unsafe expression: '+expr);
  return Function(...keys,'"use strict"; return ('+expr+');')(...vals);
}
function safeEvalOrLiteral(expr,scope){
  if(typeof expr!=='string') return expr;
  const hasOp=/[+\-*/^()=<>]|Math\./.test(expr);
  try{ if(hasOp) return evalExpr(expr,scope); if(expr in scope) return scope[expr]; return expr; }catch{ return expr; }
}
function tidy(s){ return String(s||'').replace(/\+\s*-/g,' - ').replace(/-\s*-/g,' + ').replace(/\b1x\b/g,'x').replace(/\b-1x\b/g,'-x').replace(/\s{2,}/g,' ').replace(/\s([,.;!?])/g,'$1'); }
function formatNumber(x,fmt){ if(typeof x!=='number'||!isFinite(x)) return x; if(fmt&&fmt.fixed!=null) return Number(x.toFixed(+fmt.fixed)); if(fmt&&fmt.round!=null){ const p=Math.pow(10,+fmt.round); return Math.round(x*p)/p; } const p=Math.pow(10,3); return Math.round(x*p)/p; }

/* --------------------- Fallback bank generator --------------------- */
function makeFallbackBank(count=150, seed='fallback'){
  const rnd=makeRng(seed), bank=[]; let id=100000;
  const topicsE=['PAM:ARITHMETIC','HOA:LINEAR','GEOT:AREA'];
  const topicsM=['PAM:PERCENTS','HOA:SYSTEMS','GEOT:RIGHT-TRI'];
  const topicsH=['PSDA:FUNCTIONS','HOA:QUADRATIC','GEOT:CIRCLES'];
  const push=(o)=>bank.push(o);

  for(let i=0;i<count*0.4;i++){
    const t=topicsE[i%topicsE.length];
    push({id:'E'+(id++), topic:t, difficulty:'E', template:{
      stem: t==='GEOT:AREA' ? 'A rectangle has length {{L}} and width {{W}}. What is its area?'
           : t==='HOA:LINEAR' ? 'Given y = 2x + {{b}}, what is y when x = {{x}}?'
           : 'What is {{A}} + {{B}}?',
      params: t==='GEOT:AREA' ? {L:{min:3,max:20}, W:{min:2,max:15}}
             : t==='HOA:LINEAR' ? {b:{min:-9,max:9}, x:{min:-6,max:6}}
             : {A:{min:10,max:60}, B:{min:10,max:60}},
      answer: t==='GEOT:AREA' ? 'L*W' : t==='HOA:LINEAR' ? '2*x + b' : 'A + B',
      distractors:['ans+1','ans-1','ans*1.1'], format:{fixed:0}
    }});
  }
  for(let i=0;i<count*0.4;i++){
    const t=topicsM[i%topicsM.length];
    push({id:'M'+(id++), topic:t, difficulty:'M', template:
      (t==='PAM:PERCENTS')?{
        stem:'A value is {{P}}% of {{B}}. What is the value?',
        params:{P:{min:10,max:90}, B:{min:50,max:400}},
        answer:'(P/100)*B', distractors:['B-P','B+P','(B/P)'], format:{round:2}
      }:(t==='HOA:SYSTEMS')?{
        stem:'Solve for x: 2x + {{c}} = {{rhs}}.',
        params:{c:{min:-10,max:10}, rhs:{min:-20,max:30}},
        answer:'(rhs - c)/2', distractors:['(rhs+c)/2','rhs-2*c','rhs/2'], format:{round:3}
      }:{
        stem:'A right triangle has legs {{a}} and {{b}}. What is the hypotenuse?',
        params:{a:{min:3,max:20}, b:{min:4,max:20}},
        answer:'Math.sqrt(a*a+b*b)', distractors:['a+b','a*b','Math.abs(a-b)'], format:{round:3}
      }
    });
  }
  for(let i=0;i<count*0.2;i++){
    const t=topicsH[i%topicsH.length];
    push({id:'H'+(id++), topic:t, difficulty:'H', template:
      (t==='HOA:QUADRATIC')?{
        stem:'For f(x) = ax^2 + bx + c with a={{a}}, b={{b}}, c={{c}}, what is the x-coordinate of the vertex?',
        params:{a:{min:1,max:5}, b:{min:-12,max:12}, c:{min:-10,max:10}},
        answer:'-b/(2*a)', distractors:['b/(2*a)','-2*a/b','c/(2*a)'], format:{round:3}
      }:(t==='GEOT:CIRCLES')?{
        stem:'A circle has radius r={{r}}. What is the circumference of a {{deg}}° arc?',
        params:{r:{min:3,max:15}, deg:{values:[30,45,60,90,120,150,180,210,240,270]}},
        derived:{frac:'deg/360'}, answer:'2*Math.PI*r*frac',
        distractors:['Math.PI*r*frac','2*Math.PI*r/deg','2*Math.PI*deg'], format:{round:3}
      }:{
        stem:'Let f(x)= {{m}}x + {{b}} and g(x)= x^2. What is (f∘g)(2)?',
        params:{m:{min:-5,max:5,exclude:[0]}, b:{min:-8,max:8}},
        answer:'m*(2*2)+b', distractors:['m*2+b','m*4-b','2*m+b'], format:{fixed:0}
      }
    });
  }
  return bank;
}

/* -------------------------- Generation core ------------------------ */
function generateItem(template, seed='demo'){
  const rnd=makeRng(seed);
  const { stem, params={}, derived={}, constraints=[], answer, distractors=[] } = template;
  const fmt = template.format || template.display || null;
  const MAX=250;

  for(let attempt=0;attempt<MAX;attempt++){
    const P={}; for(const[k,s] of Object.entries(params)) P[k]=pick(s,rnd);
    const D={}; let okDer=true;
    for(const[k,e] of Object.entries(derived||{})){ try{ D[k]=evalExpr(e,{...P,...D}); } catch{ okDer=false; break; } }
    if(!okDer) continue;
    let ok=true;
    for(const c of (constraints||[])){ try{ if(!evalExpr(c,{...P,...D})) { ok=false; break; } } catch{ ok=false; break; } }
    if(!ok) continue;

    const scope={...P,...D};
    let ans = formatNumber(safeEvalOrLiteral(answer,scope), fmt);
    const opts=[];
    for(const d of distractors){
      let v = formatNumber(safeEvalOrLiteral(d,{...scope,ans}), fmt);
      if(String(v)!==String(ans)) opts.push(v);
    }
    if(typeof ans==='number' && opts.length<3){
      const used=new Set([String(ans), ...opts.map(String)]);
      const mag = Math.max(1e-6, Math.pow(10, Math.floor(Math.log10(Math.abs(ans)||1))-1));
      const candidates=[ ans+mag, ans-mag, Math.floor(ans), Math.ceil(ans), ans*1.1, ans*0.9 ];
      for(const c of candidates){
        const v=formatNumber(c,fmt);
        if(!Number.isNaN(v) && !used.has(String(v))){ opts.push(v); used.add(String(v)); if(opts.length>=3) break; }
      }
      while(opts.length<3){
        const delta=(0.5+rnd())*mag*(rnd()<0.5?-1:1);
        const v=formatNumber(ans+delta,fmt);
        if(!used.has(String(v))){ opts.push(v); used.add(String(v)); }
      }
    }
    return { stem: tidy(renderStem(stem,scope)), answer:ans, distractors:opts.slice(0,3) };
  }
  throw new Error('Constraint not satisfiable after multiple attempts');
}
function isPlayableGen(g){
  const okAns = g && String(g.answer).trim()!=='';
  const okChoices = Array.isArray(g?.distractors) && g.distractors.length>=3;
  const okStem = g && String(g.stem||'').trim().length>5;
  return okAns && okChoices && okStem;
}

/* ---------------------------- Data load ---------------------------- */
async function safeFetchJson(url){
  try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
  catch(e){ console.warn('Skip load',url,String(e)); return null; }
}
async function loadAll(){
  const urls = Object.values(FILES).filter(Boolean);
  const all=[];
  for(const u of urls){ const arr=await safeFetchJson(u); if(Array.isArray(arr)) all.push(...arr); }
  if(all.length===0){
    const s=document.getElementById('status');
    if(s) s.textContent='ℹ️ Could not load external banks; using built-in fallback.';
    return makeFallbackBank(150, 'auto:'+sessionSeed);
  }
  return all;
}

/* ---------------------------- Seeding ------------------------------ */
const qs = new URLSearchParams(window.location.search);
const sessionSeed = qs.get('seed') || (()=>{ try{ const a=new Uint32Array(2); crypto.getRandomValues(a); return Date.now().toString(36)+a[0].toString(36)+a[1].toString(36);}catch{ return Date.now().toString(36)+Math.random().toString(36).slice(2);} })();
document.getElementById('seedEcho').textContent='Seed: '+sessionSeed;

/* ----------------------- Build & run modules ----------------------- */
let pool={E:[],M:[],H:[]};
let usedIds=new Set();

function splitByDifficulty(all){
  return {
    E: all.filter(x=>(x.difficulty||'M')==='E'),
    M: all.filter(x=>(x.difficulty||'M')==='M'),
    H: all.filter(x=>(x.difficulty||'M')==='H'),
  };
}
function normTopic(t){ return (t||'').toString().trim().toUpperCase(); }
function takeUnique(arr, seedTag){
  const rnd=makeRng(seedTag);
  const a=arr.filter(x=>!usedIds.has(x.id));
  const sh=a.slice();
  for(let i=sh.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [sh[i],sh[j]]=[sh[j],sh[i]]; }
  return sh;
}

function buildModule(which, routeTag){
  const bp=(which===1)?BLUEPRINT.M1:(routeTag==='hard'?BLUEPRINT.M2hard:BLUEPRINT.M2easy);
  const desired=bp.E+bp.M+bp.H;
  const seedBase = `module${which}:${routeTag}:${sessionSeed}`;

  function tryFill(byDifficultyOnly=false){
    const items=[], gens=[], topicCount=new Map();
    const withinCap=(topic)=>byDifficultyOnly || ( (topicCount.get(normTopic(topic))||0) < MAX_PER_TOPIC );
    const bump=(topic)=>topicCount.set(normTopic(topic),(topicCount.get(normTopic(topic))||0)+1);
    const buckets={H:takeUnique(pool.H,seedBase+':H'), M:takeUnique(pool.M,seedBase+':M'), E:takeUnique(pool.E,seedBase+':E')};

    async function pullOne(k){
      while(buckets[k].length){
        const it=buckets[k].shift();
        try{
          if(!withinCap(it.topic)) continue;
          const g=generateItem(it.template||it, `${seedBase}:${it.id||it.topic||'x'}`);
          if(isPlayableGen(g)){ items.push(it); gens.push(g); usedIds.add(it.id||String(items.length)+'@FALL'); bump(it.topic||'GEN'); return true; }
        }catch{}
      }
      return false;
    }

    const need={H:bp.H,M:bp.M,E:bp.E};
    for(const k of ['H','M','E']){
      for(let i=0;i<need[k];i++){
        if(!(await pullOne(k))){
          if(k==='H' && (await pullOne('M'))) continue;
          if((k!=='E') && (await pullOne('E'))) continue;
          break;
        }
      }
    }

    let attempts=0; const rest=[...buckets.H,...buckets.M,...buckets.E];
    while(items.length<desired && attempts<rest.length){
      const it=rest[attempts++]; try{
        if(!withinCap(it.topic)) continue;
        const g=generateItem(it.template||it, `${seedBase}:pad:${it.id||attempts}`);
        if(isPlayableGen(g)){ items.push(it); gens.push(g); usedIds.add(it.id||String(items.length)+'@PAD'); bump(it.topic||'GEN'); }
      }catch{}
    }
    return {items, gens};
  }

  let built=tryFill(false); if(built.items.length>=desired) return built;
  built=tryFill(true); if(built.items.length>=desired) return built;

  const all=takeUnique([...pool.H,...pool.M,...pool.E], seedBase+':any');
  const items=[], gens=[];
  for(const it of all){
    try{
      const g=generateItem(it.template||it, `${seedBase}:any:${it.id||'z'}`);
      if(isPlayableGen(g)){ items.push(it); gens.push(g); usedIds.add(it.id||String(items.length)+'@ANY'); }
      if(items.length>=desired) break;
    }catch{}
  }
  return {items, gens};
}

/* ------------------------------ State ------------------------------ */
let state={module:1, items:[], gens:[], answers:new Map(), idx:0, timer:null, remaining:MODULE_TIME, route:'easy', reviews:{1:null,2:null}};

function startTimer(){
  clearInterval(state.timer);
  const el=document.getElementById('hdrTimer');
  const render=()=>{ const m=Math.floor(state.remaining/60), s=state.remaining%60; el.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; };
  render();
  state.timer=setInterval(()=>{ state.remaining--; if(state.remaining<=0){ clearInterval(state.timer); submitModule(); } else render(); },1000);
}

function show(idx){
  const total=state.gens.length;
  if(total===0){
    document.getElementById('intro').style.display='none';
    document.getElementById('qCard').style.display='none';
    const s=document.getElementById('summary'); s.style.display='';
    s.innerHTML=`<h2 style="margin:0 0 6px;">Couldn’t build this module</h2>
      <p class="tiny">We tried several fallbacks but still ran short.</p>
      <div style="margin-top:10px"><button class="btn" onclick="location.reload()">Try again</button></div>`;
    return;
  }
  state.idx=Math.max(0,Math.min(idx,total-1));
  const g=state.gens[state.idx], t=state.items[state.idx];

  document.getElementById('intro').style.display='none';
  document.getElementById('qCard').style.display='';
  document.getElementById('summary').style.display='none';

  document.getElementById('qNum').textContent=`Q ${state.idx+1} of ${total}`;
  document.getElementById('qDbg').textContent=`ID ${t.id||'—'}`;
  document.getElementById('qStem').textContent=g.stem;

  const opts=seededShuffle([g.answer,...g.distractors], `opts:${sessionSeed}:${state.module}:${state.idx}`);
  const chosen=state.answers.get(state.idx) ?? null;
  const wrap=document.getElementById('qChoices'); wrap.innerHTML='';
  opts.forEach((o,i)=>{
    const id=`opt${state.idx}_${i}`;
    const div=document.createElement('label'); div.className='choice';
    div.innerHTML=`<input type="radio" name="q${state.idx}" id="${id}" value="${String(o)}"> <span>${String(o)}</span>`;
    const input=div.querySelector('input'); if(chosen!==null && String(chosen)===String(o)) input.checked=true;
    input.addEventListener('change',()=> state.answers.set(state.idx,String(o)));
    wrap.appendChild(div);
  });

  document.getElementById('btnPrev').disabled = state.idx===0;
  const last=state.idx===total-1;
  document.getElementById('btnNext').style.display= last? 'none':'';
  document.getElementById('btnSubmitModule').style.display= last? '':'none';
}

function scoreModule(){ let correct=0; state.gens.forEach((g,i)=>{ const a=state.answers.get(i); if(String(a)===String(g.answer)) correct++; }); return correct; }

function moduleReviewHTML(modNum){
  let html=`<h2 style="margin:0 0 8px;">Module ${modNum} — Review</h2>`;
  state.gens.forEach((g,i)=>{
    const your=state.answers.get(i), ok=String(your)===String(g.answer), item=state.items[i];
    const tpc=item.topic ? `<span class="chip" style="margin-left:6px">${item.topic}</span>` : '';
    html+=`<div style="padding:10px 0;border-top:1px solid #eef3ff">
      <div class="tiny">Q ${i+1} • ID ${item.id||'—'} ${tpc}</div>
      <div>${g.stem}</div>
      <div class="tiny ${ok?'green':'red'}" style="margin-top:6px">Your answer: ${your??'—'} • Correct: ${g.answer}</div>
    </div>`;
  });
  return html;
}

function submitModule(){
  clearInterval(state.timer);
  const correct=scoreModule(), total=state.gens.length;
  const sum=document.getElementById('summary'); sum.style.display=''; document.getElementById('qCard').style.display='none';

  const branch=(state.module===1)?(correct>=BRANCH_THRESHOLD?'hard':'easy'):state.route;

  if(state.module===1){
    state.reviews[1]=moduleReviewHTML(1);
    let html=`<h2 style="margin:0 0 6px;">Module 1 complete</h2>`;
    html+=`<p><strong>Score:</strong> ${correct} / ${total} ${correct>=BRANCH_THRESHOLD?'<span class="green">(Good!)</span>':''}</p>`;
    html+=`<p class="tiny">Seed: <code>${sessionSeed}</code></p>`;
    html+=`<div class="alert" style="margin-top:10px">Routing to <strong>${branch.toUpperCase()}</strong> Module 2 (threshold: ${BRANCH_THRESHOLD}+ correct → Hard).</div>`;
    html+=`<div style="margin-top:12px"><button id="btnBeginM2" class="btn">Begin Module 2</button></div>`;
    sum.innerHTML=html;
    state.route=branch;
    document.getElementById('btnBeginM2').onclick=()=>beginModule2();
  }else{
    state.reviews[2]=moduleReviewHTML(2);
    let html=`<h2 style="margin:0 0 6px;">Practice Complete</h2>`;
    html+=`<p class="tiny">Seed: <code>${sessionSeed}</code></p>`;
    html+=`<div style="margin:10px 0;">
      <button class="btn" onclick="toggleSection('rev1')">Toggle Module 1 Review</button>
      <button class="btn" style="margin-left:8px" onclick="toggleSection('rev2')">Toggle Module 2 Review</button>
    </div>`;
    html+=`<div id="rev1" style="display:block">${state.reviews[1]||'<div class="tiny">No data for Module 1.</div>'}</div>`;
    html+=`<div id="rev2" style="display:block; margin-top:16px">${state.reviews[2]||'<div class="tiny">No data for Module 2.</div>'}</div>`;
    html+=`<div style="margin-top:12px"><button class="btn" onclick="location.reload()">New Test (new seed)</button></div>`;
    sum.innerHTML=html;
  }
}

function toggleSection(id){ const el=document.getElementById(id); if(!el) return; el.style.display=(el.style.display==='none')?'block':'none'; }

async function beginModule1(){
  document.getElementById('hdrModule').textContent='Module 1';
  document.getElementById('status').textContent='Loading question bank…';
  const all=await loadAll(); pool=splitByDifficulty(all);
  usedIds.clear(); state.module=1; state.answers=new Map(); state.remaining=MODULE_TIME;
  const built=buildModule(1,'base'); state.items=built.items; state.gens=built.gens;
  if(state.gens.length===0){ document.getElementById('status').textContent='⚠️ Could not build Module 1.'; show(0); return; }
  document.getElementById('status').textContent='Module 1 ready.'; show(0); startTimer();
}

function beginModule2(){
  document.getElementById('hdrModule').textContent='Module 2';
  document.getElementById('status').textContent='Building Module 2…';
  state.module=2; state.answers=new Map(); state.remaining=MODULE_TIME;
  const built=buildModule(2,state.route); state.items=built.items; state.gens=built.gens;
  if(state.gens.length===0){ document.getElementById('status').textContent='⚠️ Could not build Module 2.'; show(0); return; }
  document.getElementById('status').textContent='Module 2 ready.'; show(0); startTimer();
}

/* ---------------------------- UI wiring ---------------------------- */
document.getElementById('btnStart')?.addEventListener('click', beginModule1); // redundant but harmless
document.getElementById('btnPrev').addEventListener('click',()=>show(state.idx-1));
document.getElementById('btnNext').addEventListener('click',()=>show(state.idx+1));
document.getElementById('btnSubmitModule').addEventListener('click', submitModule);

function enableDrag(popId){
  const pop=document.getElementById(popId);
  const head=pop.querySelector('.head');
  let dragging=false, sx=0, sy=0, sl=0, st=0;
  head.addEventListener('mousedown',(e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=pop.getBoundingClientRect(); sl=r.left; st=r.top; e.preventDefault(); });
  window.addEventListener('mousemove',(e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; pop.style.left=(sl+dx)+'px'; pop.style.top=(st+dy)+'px'; pop.style.right='auto'; pop.style.bottom='auto'; });
  window.addEventListener('mouseup',()=> dragging=false);
}
enableDrag('popCalc'); enableDrag('popRef');

document.getElementById('btnCalc').onclick=()=>{ document.getElementById('popCalc').style.display='block'; };
document.getElementById('btnRef').onclick =()=>{ document.getElementById('popRef').style.display='block'; };
document.querySelector('[data-close="calc"]').onclick=()=>document.getElementById('popCalc').style.display='none';
document.querySelector('[data-close="ref"]').onclick =()=>document.getElementById('popRef').style.display='none';

/* Reference image (placeholder if missing) */
document.getElementById('refImg').src = REFERENCE_IMG;
document.getElementById('refImg').onerror = function(){
  this.alt='Reference sheet image not found at '+REFERENCE_IMG;
  this.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="720" height="480"><rect width="100%" height="100%" fill="white"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18" fill="#113a92">SAT Math Reference sheet not found — place /data/sat-reference.jpg</text></svg>`);
};
</script>
</body>
</html>
