<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SAT Math — Adaptive Practice (2 Modules)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<style>
  :root{
    --cb-blue:#1f4db5;
    --cb-blue-600:#113a92;
    --cb-blue-100:#eaf0ff;
    --ink:#0b1020;
    --bg:#f7f9ff;
    --card:#ffffff;
    --muted:#66759a;
    --ok:#0a7c3b;
    --bad:#c4322b;
  }
  html,body{margin:0;height:100%; background:var(--bg); color:var(--ink); font:16px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
  header.topbar{
    background:var(--cb-blue);
    color:#fff;
    padding:10px 16px;
    display:flex;
    align-items:center;
    gap:16px;
    box-shadow:0 1px 0 var(--cb-blue-600) inset, 0 2px 8px rgba(0,0,0,.08);
    position:sticky; top:0; z-index:20;
  }
  .brand{font-weight:700}
  .pill{background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.35); padding:6px 10px; border-radius:999px; font-weight:600}
  .spacer{flex:1}
  .btn{
    background:#fff; color:var(--cb-blue); border:1px solid var(--cb-blue);
    font-weight:600; padding:8px 12px; border-radius:10px; cursor:pointer;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  main{max-width:1050px; margin:16px auto; padding:0 16px 40px}
  .card{background:var(--card); border:1px solid #dfe6ff; border-radius:14px; padding:16px; box-shadow:0 3px 12px rgba(31,77,181,.08)}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .qnum{background:var(--cb-blue-100); color:var(--cb-blue); border:1px solid var(--cb-blue); padding:4px 8px; border-radius:10px; font-weight:700}
  .stem{font-size:18px; margin:10px 0 12px}
  .choices{display:grid; gap:10px; margin-top:8px}
  .choice{border:1px solid #cfe0ff; border-radius:12px; padding:12px; background:#fff; cursor:pointer; display:flex; align-items:center; gap:12px}
  .choice:hover{border-color:var(--cb-blue)}
  .choice input{accent-color:var(--cb-blue)}
  .nav{display:flex; gap:10px; justify-content:space-between; margin-top:16px}
  .tiny{font-size:13px; color:var(--muted)}
  .status{margin:10px 0; color:var(--muted)}
  .green{color:var(--ok)}
  .red{color:var(--bad)}
  .pop{position:fixed; right:20px; bottom:20px; width:520px; height:420px; background:#fff;
       border:1px solid #ccd6ff; border-radius:14px; box-shadow:0 20px 50px rgba(17,58,146,.28); z-index:99; display:none}
  .pop .head{user-select:none; cursor:move; height:42px; background:var(--cb-blue); color:#fff; border-radius:14px 14px 0 0;
             display:flex; align-items:center; justify-content:space-between; padding:0 12px;}
  .pop .body{height:calc(100% - 42px); background:#fff; border-radius:0 0 14px 14px; overflow:hidden}
  .pop .x{background:transparent; border:1px solid rgba(255,255,255,.75); color:#fff; border-radius:8px; padding:4px 8px; cursor:pointer}
  .ref-img{width:100%; height:100%; object-fit:contain; background:#fff}
  .calc-iframe{width:100%; height:100%; border:0}
  .dock{display:flex; gap:10px}
  .dock .btn{background:#fff; color:var(--cb-blue); border-color:#cfe0ff}
  .alert{padding:10px 12px; border-radius:10px; background:#fff8d6; border:1px solid #ffe487}
  .chip{padding:2px 8px;border-radius:999px;background:var(--cb-blue-100); border:1px solid #cfe0ff; color:#143b8d; font-weight:600}
  .dbg{margin-left:8px; background:#eef3ff; border:1px solid #cfe0ff; color:#113a92; padding:4px 8px; border-radius:999px; font-weight:600}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">Math Practice — 2 Module Adaptive</div>
  <div id="hdrModule" class="pill">Module 1</div>
  <div id="hdrTimer" class="pill">35:00</div>
  <div class="spacer"></div>
  <div class="dock">
    <button id="btnRef" class="btn">Reference</button>
    <button id="btnCalc" class="btn">Calculator</button>
  </div>
</header>

<main>
  <div id="status" class="status"></div>

  <div id="intro" class="card">
    <h2 style="margin:0 0 6px;">Welcome</h2>
    <p class="tiny">Two adaptive modules • 22 questions each • 35 minutes per module. A new random session seed is created
      every time you open this page (unless you include <code>?seed=</code> in the URL).</p>
    <div style="margin-top:10px">
      <button id="btnStart" class="btn">Start Module 1</button>
      <span id="seedEcho" class="tiny" style="margin-left:8px;"></span>
    </div>
  </div>

  <div id="qCard" class="card" style="display:none">
    <div class="row">
      <div id="qNum" class="qnum">Q 1</div>
      <div id="qDbg" class="dbg">ID —</div>
      <div class="spacer"></div>
    </div>
    <div id="qStem" class="stem">Loading…</div>
    <div id="qChoices" class="choices"></div>

    <div class="nav">
      <button id="btnPrev" class="btn">Back</button>
      <div class="spacer"></div>
      <button id="btnNext" class="btn">Next</button>
      <button id="btnSubmitModule" class="btn" style="display:none">Submit Module</button>
    </div>
  </div>

  <div id="summary" class="card" style="display:none"></div>
</main>

<!-- Pop-outs -->
<div id="popCalc" class="pop" aria-modal="true">
  <div class="head" data-drag="calc"><span>Desmos Calculator</span><button class="x" data-close="calc">✕</button></div>
  <div class="body">
    <iframe class="calc-iframe"
      src="https://www.desmos.com/test-mode?lang=en&mode=sat&embed"
      title="Desmos SAT Calculator"></iframe>
  </div>
</div>

<div id="popRef" class="pop" aria-modal="true" style="width:760px;height:520px; right:560px;">
  <div class="head" data-drag="ref"><span>Reference Sheet</span><button class="x" data-close="ref">✕</button></div>
  <div class="body" style="padding:8px; background:#fff">
    <img id="refImg" class="ref-img" alt="SAT Math Reference Sheet">
  </div>
</div>

<script>
/* ------------------------------------------------------------------ */
/* Configuration (works in Codespaces and GitHub Pages)                */
/* ------------------------------------------------------------------ */

/* If test.html is served from /docs/, go up one level to reach /data; else use current dir */
const PREFIX = location.pathname.includes('/docs/') ? '..' : '.';

const FILES = {
  HOA: `${PREFIX}/data/CLEAN_HOA_SAT.json`,
  PAM: `${PREFIX}/data/CLEAN_PAM_SAT.json`,
  GEOT: `${PREFIX}/data/CLEAN_GEOT_SAT.json`,
  PSDA: `${PREFIX}/data/CLEAN_PSDA_SAT.json`,
  // Optional fallbacks if you host MASTER_* files too:
  // HOA_FALLBACK: `${PREFIX}/data/MASTER_HOA_SAT.json`,
  // PAM_FALLBACK: `${PREFIX}/data/MASTER_PAM_SAT.json`,
  // GEOT_FALLBACK: `${PREFIX}/data/MASTER_GEOT_SAT.json`,
  // PSDA_FALLBACK: `${PREFIX}/data/MASTER_PSDA_SAT.json`,
};

const REFERENCE_IMG = `${PREFIX}/data/sat-reference.jpg`;

/* Difficulty blueprint (counts per module) */
const BLUEPRINT = {
  M1:     {E:7, M:10, H:5},  // Module 1
  M2easy: {E:9, M:11, H:2},  // Module 2 routed EASY
  M2hard: {E:3, M:12, H:7},  // Module 2 routed HARD
};
/* Route threshold: >= this correct on M1 → HARD route */
const BRANCH_THRESHOLD = 14;
/* Time per module (seconds) */
const MODULE_TIME = 35*60;
/* Light topic diversity guard per module (cap per topic)  */
const MAX_PER_TOPIC = 6;

/* ------------------------------------------------------------------ */
/* Seed, utilities, safe eval                                         */
/* ------------------------------------------------------------------ */
window.addEventListener('error', e=>{
  const el=document.getElementById('status');
  if(el) el.textContent='⚠️ Script error: '+(e.error?.message||e.message||'unknown');
});
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=Math.imul(h1^k,597399067);h2=Math.imul(h2^k,2869860233);h3=Math.imul(h3^k,951274213);h4=Math.imul(h4^k,2716044179);}h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);return[(h1^h2^h3^h4)>>>0];}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
function makeRng(seed){const[s]=cyrb128(String(seed));return mulberry32(s);}
function seededShuffle(arr, seed){const rnd=makeRng(seed);const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function pick(spec,rnd){
  if(!spec) throw new Error('Bad param spec');
  if(Array.isArray(spec.values)){ const a=spec.values; return a[Math.floor(rnd()*a.length)]; }
  const min=spec.min??0, max=spec.max??min, exclude=new Set(spec.exclude||[]);
  const isInt=Number.isInteger(min)&&Number.isInteger(max);
  for(let i=0;i<400;i++){
    const v=isInt?Math.floor(min+rnd()*(max-min+1)):(min+rnd()*(max-min));
    if(!exclude.has(v)) return v;
  }
  throw new Error('Could not sample param (too restrictive).');
}
function renderStem(stem,vars){return String(stem||'').replace(/\{\{\s*([a-zA-Z_]\w*)\s*\}\}/g,(_,k)=>(k in vars?String(vars[k]):`{{${k}}}`));}
function evalExpr(expr,scope){
  const keys=['Math','Number',...Object.keys(scope)], vals=[Math,Number,...Object.values(scope)];
  if(typeof expr!=='string') return expr;
  if(/[;{}\[\]]|new|class|function|=>|import|export|process|global|window/i.test(expr)) throw new Error('Unsafe expression: '+expr);
  return Function(...keys,'"use strict"; return ('+expr+');')(...vals);
}
function safeEvalOrLiteral(expr,scope){
  if(typeof expr!=='string') return expr;
  const hasOp=/[+\-*/^()=<>]|Math\./.test(expr);
  try{
    if(hasOp) return evalExpr(expr,scope);
    if(expr in scope) return scope[expr];
    return expr;
  }catch{ return expr; }
}
function tidy(s){
  return String(s||'')
    .replace(/\+\s*-/g,' - ')
    .replace(/-\s*-/g,' + ')
    .replace(/\b1x\b/g,'x')
    .replace(/\b-1x\b/g,'-x')
    .replace(/\s{2,}/g,' ')
    .replace(/\s([,.;!?])/g,'$1');
}
function formatNumber(x,fmt){
  if(typeof x!=='number' || !isFinite(x)) return x;
  if(fmt && fmt.fixed!=null) return Number(x.toFixed(+fmt.fixed));
  if(fmt && fmt.round!=null){ const p=Math.pow(10,+fmt.round); return Math.round(x*p)/p; }
  const p=Math.pow(10,3); return Math.round(x*p)/p;
}

/* ------------------------------------------------------------------ */
/* Fallback bank generator (used when JSON fetch fails)                */
/* ------------------------------------------------------------------ */
function makeFallbackBank(count = 140, seed='fallback'){
  const rnd = makeRng(seed);
  const bank = [];
  let id = 100000;

  const push = (obj)=>bank.push(obj);

  const topicsE = ['PAM:ARITHMETIC','HOA:LINEAR','GEOT:AREA'];
  const topicsM = ['PAM:PERCENTS','HOA:SYSTEMS','GEOT:RIGHT-TRI'];
  const topicsH = ['PSDA:FUNCTIONS','HOA:QUADRATIC','GEOT:CIRCLES'];

  // Easy: sums, unit price, rectangle area, simple linear plug-in
  for(let i=0;i<count*0.4;i++){
    const t = topicsE[i%topicsE.length];
    const a = 3+Math.floor(rnd()*47), b = 2+Math.floor(rnd()*38);
    push({
      id: 'E'+(id++), topic: t, difficulty: 'E',
      template:{
        stem: t==='GEOT:AREA'
          ? 'A rectangle has length {{L}} and width {{W}}. What is its area?'
          : t==='HOA:LINEAR'
            ? 'Given y = 2x + {{b}}, what is y when x = {{x}}?'
            : 'What is {{A}} + {{B}}?',
        params: t==='GEOT:AREA'
          ? {L:{min:3,max:20}, W:{min:2,max:15}}
          : t==='HOA:LINEAR'
            ? {b:{min:-9,max:9}, x:{min:-6,max:6}}
            : {A:{min:10,max:60}, B:{min:10,max:60}},
        answer: t==='GEOT:AREA'
          ? 'L*W'
          : t==='HOA:LINEAR'
            ? '2*x + b'
            : 'A + B',
        distractors: ['ans+1','ans-1','ans*1.1'],
        format:{fixed:0}
      }
    });
  }

  // Medium: percent change, systems (elimination numeric), right triangle Pythag
  for(let i=0;i<count*0.4;i++){
    const t = topicsM[i%topicsM.length];
    push({
      id: 'M'+(id++), topic: t, difficulty: 'M',
      template: (t==='PAM:PERCENTS') ? {
        stem: 'A value is {{P}}% of {{B}}. What is the value?',
        params:{P:{min:10,max:90}, B:{min:50,max:400}},
        answer: '(P/100)*B',
        distractors: ['B-P','B+P','(B/P)'],
        format:{round:2}
      } : (t==='HOA:SYSTEMS') ? {
        stem: 'Solve for x: 2x + {{c}} = {{rhs}}.',
        params:{c:{min:-10,max:10}, rhs:{min:-20,max:30}},
        answer: '(rhs - c)/2',
        distractors: ['(rhs+c)/2','rhs-2*c','rhs/2'],
        format:{round:3}
      } : {
        stem: 'A right triangle has legs {{a}} and {{b}}. What is the hypotenuse?',
        params:{a:{min:3,max:20}, b:{min:4,max:20}},
        answer: 'Math.sqrt(a*a+b*b)',
        distractors: ['a+b','a*b','Math.abs(a-b)'],
        format:{round:3}
      }
    });
  }

  // Hard: vertex of quadratic, circle sector length, composite function
  for(let i=0;i<count*0.2;i++){
    const t = topicsH[i%topicsH.length];
    push({
      id:'H'+(id++), topic:t, difficulty:'H',
      template: (t==='HOA:QUADRATIC') ? {
        stem: 'For f(x) = ax^2 + bx + c with a={{a}}, b={{b}}, c={{c}}, what is the x-coordinate of the vertex?',
        params:{a:{min:1,max:5}, b:{min:-12,max:12}, c:{min:-10,max:10}},
        answer: '-b/(2*a)',
        distractors: ['b/(2*a)','-2*a/b','c/(2*a)'],
        format:{round:3}
      } : (t==='GEOT:CIRCLES') ? {
        stem: 'A circle has radius r={{r}}. What is the circumference of a {{deg}}° arc?',
        params:{r:{min:3,max:15}, deg:{values:[30,45,60,90,120,150,180,210,240,270]}},
        derived:{frac:'deg/360'},
        answer: '2*Math.PI*r*frac',
        distractors: ['Math.PI*r*frac','2*Math.PI*r/deg','2*Math.PI*deg'],
        format:{round:3}
      } : {
        stem: 'Let f(x)= {{m}}x + {{b}} and g(x)= x^2. What is (f∘g)(2)?',
