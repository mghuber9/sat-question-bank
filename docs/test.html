<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SAT Practice — Math</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">

  <!-- KaTeX for any math in the UI -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <!-- Desmos official API (demo key from Desmos docs) -->
  <script src="https://www.desmos.com/api/v1.11/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>

  <style>
    :root{
      --blue-900:#163d86;  /* header */
      --blue-800:#1f4fa7;
      --blue-700:#2a66cf;  /* buttons/accent */
      --blue-100:#e8f1ff;
      --text:#0f172a;
      --muted:#486080;
      --card:#ffffff;
      --bg:#f6f8fc;
      --border:#d8e1f1;
      --shadow:0 2px 10px rgba(15, 23, 42, .08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    /* Top bar */
    .top{position:sticky;top:0;z-index:50;background:var(--blue-900);color:#fff;box-shadow:var(--shadow)}
    .top .row{display:flex;align-items:center;gap:16px;padding:10px 16px}
    .brand{font-weight:700;letter-spacing:.2px}
    .gutter{flex:1}
    .pill{background:rgba(255,255,255,.12);padding:6px 10px;border-radius:999px}
    .btn{background:var(--blue-700);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.5)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .timer{min-width:78px;text-align:center;font-variant-numeric:tabular-nums}

    /* Main layout */
    .wrap{max-width:980px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
    .qhead{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .qnum{background:var(--blue-100);border:1px solid var(--border);color:var(--blue-900);width:26px;height:26px;border-radius:6px;display:grid;place-items:center;font-weight:700}
    .stem{font-size:17px}
    .choices{margin-top:12px;display:grid;gap:8px}
    .choice{border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;background:#fff}
    .choice:hover{border-color:var(--blue-700)}
    .choice.selected{outline:2px solid var(--blue-700)}
    .constructed{display:flex;gap:10px;align-items:center;margin-top:10px}
    .constructed input{padding:10px 12px;border:1px solid var(--border);border-radius:8px;min-width:160px}
    .nav{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:10px}
    .muted{color:var(--muted)}

    /* Floating tool windows */
    .tool-window{
      position:fixed;left:40px;top:90px;width:520px;background:#fff;border:1px solid var(--border);
      border-radius:12px;box-shadow:0 14px 40px rgba(0,0,0,.18);display:none;flex-direction:column;z-index:60;
    }
    .tool-window.active{display:flex}
    .titlebar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;background:var(--blue-800);color:#fff;border-radius:12px 12px 0 0;
      cursor:grab;user-select:none;
    }
    .titlebar:active{cursor:grabbing}
    .titlebar h3{margin:0;font-size:14px;font-weight:700;letter-spacing:.2px}
    .tool-actions{display:flex;gap:6px}
    .tiny{background:rgba(255,255,255,.15);color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer}
    .tiny:hover{background:rgba(255,255,255,.25)}
    .content{padding:0;background:#fff;border-radius:0 0 12px 12px}
    .tabs{display:flex;gap:6px;padding:10px;border-bottom:1px solid var(--border)}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .tab.active{background:var(--blue-100);border-color:var(--blue-700);color:var(--blue-900);font-weight:600}

    /* Desmos containers */
    .calc-holder{height:460px;padding:0 10px 10px}
    .calc-canvas{width:100%;height:100%;border:0;border-radius:0 0 12px 12px}

    /* Reference sheet image */
    .ref-wrap{padding:12px}
    .ref-img{width:100%;height:auto;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow)}
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="top">
    <div class="row">
      <div class="brand">Section 1 — Math</div>
      <div class="pill timer" id="timer">35:00</div>
      <div class="gutter"></div>
      <button class="btn secondary" id="btnRef">Reference</button>
      <button class="btn" id="btnCalc">Calculator</button>
    </div>
  </div>

  <!-- Main -->
  <main class="wrap">
    <div class="card" id="statusCard"><div class="muted" id="status">Loading module…</div></div>

    <div class="card" id="qCard" style="display:none">
      <div class="qhead">
        <div class="qnum" id="qNum">1</div>
        <div class="muted" id="qLoc">Question 1 of 22</div>
      </div>
      <div class="stem" id="stem">—</div>

      <div id="mcWrap" class="choices" style="display:none"></div>

      <div id="crWrap" class="constructed" style="display:none">
        <label for="crInput" class="muted">Answer:</label>
        <input id="crInput" type="text" inputmode="decimal" autocomplete="off" />
      </div>

      <div class="nav">
        <button class="btn secondary" id="prevBtn">Back</button>
        <div class="muted" id="navStatus">—</div>
        <button class="btn" id="nextBtn">Next</button>
      </div>
    </div>
  </main>

  <!-- CALCULATOR WINDOW (Desmos API) -->
  <div id="calcWin" class="tool-window" style="left:40px;top:110px;">
    <div class="titlebar" data-handle>
      <h3>Calculator</h3>
      <div class="tool-actions">
        <a class="tiny" target="_blank" rel="noopener" href="https://www.desmos.com/calculator?lang=en">Pop out ↗</a>
        <button class="tiny" data-close aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content">
      <div class="tabs">
        <button class="tab active" data-tab="graph">Graphing</button>
        <button class="tab" data-tab="sci">Scientific</button>
      </div>
      <div class="calc-holder">
        <div id="graphCalc" class="calc-canvas"></div>
        <div id="sciCalc" class="calc-canvas" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- REFERENCE WINDOW (exact sheet as image) -->
  <div id="refWin" class="tool-window" style="width:760px;left:120px;top:160px;">
    <div class="titlebar" data-handle>
      <h3>Reference Sheet</h3>
      <div class="tool-actions"><button class="tiny" data-close aria-label="Close">✕</button></div>
    </div>
    <div class="content">
      <div class="ref-wrap">
        <!-- Put your image at docs/data/reference.png -->
        <img class="ref-img" src="data/reference.png" alt="SAT Math Reference Sheet">
      </div>
    </div>
  </div>

<script>
/* =============== error surface =============== */
window.addEventListener('error', e => {
  const s = document.getElementById('status');
  if (s) s.textContent = '⚠️ Script error: ' + (e.error?.message || e.message || 'unknown');
});

/* =============== draggable windows (titlebar only) =============== */
function makeDraggable(win){
  const handle = win.querySelector('[data-handle]');
  let startX=0, startY=0, startL=0, startT=0, dragging=false, moved=false, zTop=60;
  const THRESH = 3;

  function onMouseDown(e){
    if (e.button !== 0) return;
    dragging=true; moved=false;
    const r = win.getBoundingClientRect();
    startX=e.clientX; startY=e.clientY; startL=r.left; startT=r.top;
    win.style.zIndex=(++zTop).toString();
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    if(!moved && (Math.abs(dx)>THRESH||Math.abs(dy)>THRESH)) moved=true;
    if(!moved) return;
    const nx=Math.max(4, Math.min(window.innerWidth-80, startL+dx));
    const ny=Math.max(4, Math.min(window.innerHeight-60, startT+dy));
    win.style.left=nx+'px'; win.style.top=ny+'px';
  }
  function onUp(){
    dragging=false;
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
  }
  handle.addEventListener('mousedown', onMouseDown);
  win.addEventListener('mousedown', ()=> win.style.zIndex=(++zTop).toString());
  win.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', ()=> win.classList.remove('active')));
}
makeDraggable(document.getElementById('calcWin'));
makeDraggable(document.getElementById('refWin'));

/* =============== open/close + Desmos init =============== */
const calcWin = document.getElementById('calcWin');
const refWin  = document.getElementById('refWin');
document.getElementById('btnCalc').addEventListener('click', ()=> {
  calcWin.classList.toggle('active');
  if (calcWin.classList.contains('active')) ensureDesmos();
});
document.getElementById('btnRef').addEventListener('click',  ()=> refWin.classList.toggle('active'));

/* Desmos instances (one-time lazy init) */
let graphCalc = null, sciCalc = null;
function ensureDesmos(){
  if (!graphCalc){
    const el = document.getElementById('graphCalc');
    graphCalc = Desmos.GraphingCalculator(el, {
      expressions: true,
      expressionsTopbar: true,
      keypad: true,
      zoomButtons: true,
      settingsMenu: false,
      invertedColors: false,
    });
  }
  if (!sciCalc){
    const el2 = document.getElementById('sciCalc');
    sciCalc = Desmos.ScientificCalculator(el2, { keypad: true });
  }
}

/* calc tabs */
(function wireCalcTabs(){
  const tabs = calcWin.querySelectorAll('.tab');
  tabs.forEach(t => t.addEventListener('click', ()=>{
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const isGraph = t.dataset.tab === 'graph';
    document.getElementById('graphCalc').style.display = isGraph ? 'block' : 'none';
    document.getElementById('sciCalc').style.display   = isGraph ? 'none'  : 'block';
    ensureDesmos();
  }));
})();

/* =============== mini demo engine (same as before) =============== */
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=Math.imul(h1^k,597399067);h2=Math.imul(h2^k,2869860233);h3=Math.imul(h3^k,951274213);h4=Math.imul(h4^k,2716044179);}h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);return[(h1^h2^h3^h4)>>>0];}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
function makeRng(seed){const[s]=cyrb128(String(seed));return mulberry32(s);}
function seededShuffle(arr,seed){const rnd=makeRng(seed);const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function pick(spec,rnd){if(!spec)throw new Error("Bad param spec");if(Array.isArray(spec.values)){const a=spec.values;return a[Math.floor(rnd()*a.length)];}const min=spec.min??0,max=spec.max??min,exclude=new Set(spec.exclude||[]),isInt=Number.isInteger(min)&&Number.isInteger(max);for(let i=0;i<400;i++){const v=isInt?Math.floor(min+rnd()*(max-min+1)):(min+rnd()*(max-min));if(!exclude.has(v))return v;}throw new Error("Could not sample param.");}
function renderStem(stem,vars){return String(stem||"").replace(/\{\{\s*([a-zA-Z_]\w*)\s*\}\}/g,(_,k)=>(k in vars?String(vars[k]):`{{${k}}}`));}
function evalExpr(expr,scope){const keys=["Math","Number",...Object.keys(scope)],vals=[Math,Number,...Object.values(scope)];if(typeof expr!=="string")return expr;if(/[;{}\[\]]|new|class|function|=>|import|export|process|global|window/i.test(expr))throw new Error("Unsafe expression: "+expr);return Function(...keys,'"use strict"; return ('+expr+');')(...vals);}
function safeEvalOrLiteral(expr,scope){if(typeof expr!=="string")return expr;const hasOp=/[+\-*/^()=<>]|Math\./.test(expr);try{if(hasOp)return evalExpr(expr,scope);if(expr in scope)return scope[expr];return expr;}catch{return expr;}}
function generateItem(tpl, seed="demo"){
  const rnd=makeRng(seed);
  const {stem,params={},derived={},constraints=[],answer,distractors=[]}=tpl;
  const MAX=250;
  for(let attempt=0;attempt<MAX;attempt++){
    const P={}; for(const[k,s] of Object.entries(params)) P[k]=pick(s,rnd);
    const D={}; let okDer=true; for(const[k,e] of Object.entries(derived)){try{D[k]=evalExpr(e,{...P,...D});}catch{okDer=false;break;}}
    if(!okDer)continue;
    let ok=true; for(const c of constraints){try{if(!evalExpr(c,{...P,...D})){ok=false;break;}}catch{ok=false;break;}} if(!ok)continue;
    let ans = safeEvalOrLiteral(answer,{...P,...D});
    const opts=[]; for(const d of distractors){const v=safeEvalOrLiteral(d,{...P,...D,ans}); if(String(v)!==String(ans)) opts.push(v);}
    return { stem:renderStem(stem,{...P,...D}), answer:ans, distractors:opts.slice(0,3) };
  }
  throw new Error("Constraint not satisfiable.");
}

const FILES={HOA:"data/MASTER_HOA_SAT.json",PAM:"data/MASTER_PAM_SAT.json",PSDA:"data/MASTER_PSDA_SAT.json",GEOT:"data/MASTER_GEOT_SAT.json"};

async function loadAll(){
  const all = await Promise.all(Object.values(FILES).map(u => fetch(u,{cache:"no-store"}).then(r=>r.json())));
  return all.flat();
}
function renderMath(){ if(window.renderMathInElement){ window.renderMathInElement(document.body,{ delimiters:[
  {left:"$$",right:"$$",display:true},{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false},{left:"$",right:"$",display:false}
], throwOnError:false}); } }

let items=[], gen=[], idx=0, answers = new Map();
function show(i){
  const card=document.getElementById('qCard'), st=document.getElementById('statusCard'); st.style.display='none'; card.style.display='block';
  idx=Math.max(0,Math.min(gen.length-1,i)); const it=gen[idx];
  document.getElementById('qNum').textContent=(idx+1);
  document.getElementById('qLoc').textContent=`Question ${idx+1} of ${gen.length}`;
  document.getElementById('stem').innerHTML=it.stem;

  const mc=document.getElementById('mcWrap'), cr=document.getElementById('crWrap'); mc.innerHTML='';
  if(it.distractors && it.distractors.length){
    mc.style.display='grid'; cr.style.display='none';
    const opts=seededShuffle([it.answer,...it.distractors],'opts:'+idx).map(v=>String(v));
    const saved=answers.get(idx);
    opts.forEach(o=>{
      const div=document.createElement('div');
      div.className='choice'+(saved===o?' selected':'');
      div.textContent=o;
      div.addEventListener('click',()=>{
        answers.set(idx,o);
        mc.querySelectorAll('.choice').forEach(c=>c.classList.remove('selected'));
        div.classList.add('selected');
      });
      mc.appendChild(div);
    });
  } else {
    mc.style.display='none'; cr.style.display='flex';
    const input=document.getElementById('crInput');
    input.value=answers.get(idx)??''; input.oninput=()=>answers.set(idx,input.value);
  }
  document.getElementById('navStatus').textContent=`${idx+1}/${gen.length}`;
  renderMath();
}
document.getElementById('prevBtn').addEventListener('click',()=>show(idx-1));
document.getElementById('nextBtn').addEventListener('click',()=>show(idx+1));

/* Timer (35:00) */
let seconds=35*60; const tEl=document.getElementById('timer');
setInterval(()=>{ if(seconds<=0) return; seconds--; const m=String(Math.floor(seconds/60)).padStart(2,'0'); const s=String(seconds%60).padStart(2,'0'); tEl.textContent=`${m}:${s}`; },1000);

/* Boot */
(async function(){
  const all=await loadAll();
  // Rough E/M/H sampling (7/10/5)
  const E=all.filter(x=>(x.difficulty||'M')==='E');
  const M=all.filter(x=>(x.difficulty||'M')==='M');
  const H=all.filter(x=>(x.difficulty||'M')==='H');
  function take(arr,n,tag){ return seededShuffle(arr,tag).slice(0,n); }
  items=[...take(E,7,'E'),...take(M,10,'M'),...take(H,5,'H')];
  const seedBase='module1';
  gen=items.map((it,i)=>generateItem(it.template,`${seedBase}:${it.id||i}`));
  document.getElementById('status').textContent='Module ready.';
  show(0);
})();
</script>
</body>
</html>
