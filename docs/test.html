<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SAT Practice — Test Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="data:,">

  <!-- KaTeX for math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{
      --blue:#0a4ad3;
      --blue-d:#083a9f;
      --bg:#0b1020;
      --panel:#121a2c;
      --card:#151f36;
      --text:#e8edf7;
      --muted:#a9b6d6;
      --ok:#1db954;
      --warn:#f6c25b;
      --danger:#ff6b6b;
      --border:#233154;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100%;}
    /* Header */
    .topbar{
      position:sticky;top:0;z-index:20;background:linear-gradient(0deg,#0f1a34, #0f1a34) padding-box,linear-gradient(90deg,#17305e,#0f1a34) border-box;
      border-bottom:1px solid var(--border);
      display:flex;gap:14px;align-items:center;padding:10px 14px;
    }
    .brand{font-weight:700}
    .pill{background:#0f1730;border:1px solid var(--border);border-radius:10px;padding:4px 8px;color:var(--muted);display:flex;align-items:center;gap:6px}
    .timer{font-weight:700;color:#fff;background:var(--blue);border-color:transparent}
    .spacer{flex:1}
    .btn{background:#0f1730;color:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--blue);border-color:var(--blue)}
    .btn:hover{filter:brightness(1.1)}
    .icon{opacity:.85}
    /* Progress bar */
    .progress-wrap{padding:6px 14px;border-bottom:1px solid var(--border);background:#0f1730}
    .progress{height:6px;background:#0c1224;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,#3395ff,#5ea0ff);width:0%}

    /* Layout */
    .wrap{max-width:980px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .qhead{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .qnum{font-weight:700;background:#0f1730;border:1px solid var(--border);border-radius:8px;padding:6px 10px}
    .review-toggle{margin-left:auto}
    .review-toggle input{display:none}
    .review-toggle label{display:flex;gap:8px;align-items:center;background:#0f1730;border:1px solid var(--border);border-radius:10px;padding:6px 10px;color:var(--muted);cursor:pointer}
    .review-toggle input:checked+label{background:#1b2544;color:#ffe28a;border-color:#5b6ea1}

    .stem{font-size:18px;line-height:1.5;white-space:pre-wrap}
    .choices{margin-top:14px;display:grid;gap:10px}
    .choice{background:#0f1730;border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:flex;gap:10px;align-items:flex-start;cursor:pointer}
    .choice input{margin-top:4px}
    .choice:hover{border-color:#38538a}
    .free{display:flex;gap:8px;align-items:center}
    .free input[type="text"]{flex:1;background:#0b1328;border:1px solid var(--border);border-radius:8px;padding:8px;color:#fff}

    /* Bottom bar */
    .bottombar{
      position:sticky;bottom:0;z-index:10;background:#0f1730;border-top:1px solid var(--border);
      display:flex;gap:12px;align-items:center;padding:10px 14px
    }
    .meta{color:var(--muted)}
    .right{margin-left:auto;display:flex;gap:8px}
    .btn.secondary{background:#0b152c}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px}
    .modal .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;max-width:1100px;width:96%;max-height:90vh;display:flex;flex-direction:column}
    .modal .panel header{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--border)}
    .modal .panel header .spacer{flex:1}
    .modal .panel .body{padding:0;overflow:auto}
    .tabs{display:flex;gap:8px}
    .tab{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0f1730;color:#fff;cursor:pointer}
    .tab.active{background:var(--blue)}
    .iframe-holder{height:70vh}
    .iframe-holder iframe{width:100%;height:100%;border:0}

    /* Reference sheet content */
    .ref-wrap{padding:16px}
    .ref-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:18px}
    .ref-card{background:#0f1730;border:1px solid var(--border);border-radius:12px;padding:12px}
    .ref-card h4{margin:0 0 8px 0;font-weight:700}
    .muted{color:var(--muted)}
    @media (max-width:860px){
      .ref-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:520px){
      .ref-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">Section 2, Module <span id="modNo">1</span>: Math</div>
    <div class="pill timer" id="timer">35:00</div>
    <div class="spacer"></div>
    <button class="btn" id="btnCalc" title="Calculator (Desmos)">Calculator</button>
    <button class="btn" id="btnRef" title="Reference Sheet">Reference</button>
  </div>

  <!-- PROGRESS -->
  <div class="progress-wrap">
    <div class="progress"><div id="progFill"></div></div>
  </div>

  <!-- QUESTION AREA -->
  <main class="wrap">
    <div class="card">
      <div class="qhead">
        <div class="qnum">Question <span id="qIndex">1</span> of <span id="qTotal">22</span></div>
        <div class="review-toggle">
          <input id="mark" type="checkbox">
          <label for="mark">⭐ Mark for Review</label>
        </div>
      </div>
      <div id="stem" class="stem"></div>
      <div id="choices" class="choices"></div>
    </div>
  </main>

  <!-- BOTTOM BAR -->
  <div class="bottombar">
    <div class="meta"><span id="routeLabel">Module 1</span></div>
    <div class="right">
      <button class="btn secondary" id="btnBack">Back</button>
      <button class="btn primary" id="btnNext">Next</button>
    </div>
  </div>

  <!-- CALCULATOR MODAL -->
  <div class="modal" id="calcModal" aria-hidden="true">
    <div class="panel">
      <header>
        <strong>Calculator</strong>
        <div class="spacer"></div>
        <div class="tabs">
          <button class="tab active" data-tab="g">Graphing</button>
          <button class="tab" data-tab="s">Scientific</button>
        </div>
        <a class="btn" target="_blank" rel="noopener" href="https://www.desmos.com/calculator?lang=en" title="Pop out">Pop out ↗</a>
        <button class="btn" id="closeCalc">Close</button>
      </header>
      <div class="body">
        <div class="iframe-holder" id="calcG"><iframe src="https://www.desmos.com/calculator?embed"></iframe></div>
        <div class="iframe-holder" id="calcS" style="display:none"><iframe src="https://www.desmos.com/scientific?embed"></iframe></div>
      </div>
    </div>
  </div>

  <!-- REFERENCE MODAL -->
  <div class="modal" id="refModal" aria-hidden="true">
    <div class="panel">
      <header>
        <strong>Reference Sheet</strong>
        <div class="spacer"></div>
        <button class="btn" id="closeRef">Close</button>
      </header>
      <div class="body ref-wrap">
        <!-- A compact SAT-style reference sheet -->
        <div class="ref-grid">
          <div class="ref-card">
            <h4>Circle</h4>
            <div>A = \( \pi r^2 \)</div>
            <div>C = \( 2\pi r \)</div>
          </div>
          <div class="ref-card">
            <h4>Rectangle</h4>
            <div>A = \( \ell w \)</div>
          </div>
          <div class="ref-card">
            <h4>Triangle</h4>
            <div>A = \( \frac12 bh \)</div>
            <div>\( c^2 = a^2 + b^2 \)</div>
          </div>
          <div class="ref-card">
            <h4>Prism</h4>
            <div>V = \( \ell w h \)</div>
          </div>
          <div class="ref-card">
            <h4>Cylinder</h4>
            <div>V = \( \pi r^2 h \)</div>
          </div>
          <div class="ref-card">
            <h4>Sphere</h4>
            <div>V = \( \frac{4}{3}\pi r^3 \)</div>
          </div>
          <div class="ref-card">
            <h4>Cone</h4>
            <div>V = \( \frac{1}{3}\pi r^2 h \)</div>
          </div>
          <div class="ref-card">
            <h4>Pyramid</h4>
            <div>V = \( \frac{1}{3}\ell w h \)</div>
          </div>
        </div>
        <p class="muted" style="margin-top:16px">
          The number of degrees of arc in a circle is 360. The number of radians of arc in a circle is \(2\pi\).  
          The sum of the measures in degrees of the angles of a triangle is 180.
        </p>
        <h4 style="margin-top:8px">Special Right Triangles</h4>
        <p>\(30^\circ-60^\circ-90^\circ\): sides \(x, x\sqrt{3}, 2x\). &nbsp; 
           \(45^\circ-45^\circ-90^\circ\): sides \(s, s, s\sqrt{2}\).</p>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG (easy to tweak) ---------- */
const MODULE_TIME_SECONDS = 35 * 60;

/* Difficulty mix approximations (public info–style) */
const MIX = {
  m1: {E: 13, M: 7, H: 2},
  m2_easy: {E: 14, M: 8, H: 0},
  m2_hard: {E: 6,  M: 8, H: 8}
};
const ROUTE_THRESHOLD = 14; // correct needed in Module 1 to route to hard Module 2

/* Banks */
const FILES = {
  HOA: "data/MASTER_HOA_SAT.json",
  PAM: "data/MASTER_PAM_SAT.json",
  PSDA: "data/MASTER_PSDA_SAT.json",
  GEOT: "data/MASTER_GEOT_SAT.json"
};

/* ---------- UI elements ---------- */
const el = {
  timer: document.getElementById('timer'),
  prog:  document.getElementById('progFill'),
  modNo: document.getElementById('modNo'),
  routeLabel: document.getElementById('routeLabel'),
  qIndex: document.getElementById('qIndex'),
  qTotal: document.getElementById('qTotal'),
  stem:   document.getElementById('stem'),
  choices:document.getElementById('choices'),
  mark:   document.getElementById('mark'),
  back:   document.getElementById('btnBack'),
  next:   document.getElementById('btnNext'),
  calcBtn:document.getElementById('btnCalc'),
  refBtn: document.getElementById('btnRef'),
  calcModal:document.getElementById('calcModal'),
  refModal: document.getElementById('refModal'),
  closeCalc:document.getElementById('closeCalc'),
  closeRef: document.getElementById('closeRef')
};

/* ---------- RNG (deterministic) ---------- */
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=Math.imul(h1^k,597399067);h2=Math.imul(h2^k,2869860233);h3=Math.imul(h3^k,951274213);h4=Math.imul(h4^k,2716044179);}h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);return[(h1^h2^h3^h4)>>>0];}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
function rng(seed){const[s]=cyrb128(String(seed));return mulberry32(s);}

/* ---------- generator (same as viewer; includes rounding) ---------- */
function renderStem(stem, vars){ return String(stem||"").replace(/\{\{\s*([a-zA-Z_]\w*)\s*\}\}/g,(_,k)=> (k in vars? String(vars[k]) : `{{${k}}}`)); }
function evalExpr(expr, scope){
  const keys=["Math","Number",...Object.keys(scope)];
  const vals=[Math,Number,...Object.values(scope)];
  if(typeof expr!=="string") return expr;
  if(/[;{}\[\]]|new|class|function|=>|import|export|process|global|window/i.test(expr)) throw new Error("Unsafe expression: "+expr);
  return Function(...keys, '"use strict"; return ('+expr+');')(...vals);
}
function safeEvalOrLiteral(expr, scope){
  if(typeof expr!=="string") return expr;
  const hasOp=/[+\-*/^()=<>]|Math\./.test(expr);
  try{
    if(hasOp) return evalExpr(expr,scope);
    if(expr in scope) return scope[expr];
    return expr;
  }catch{ return expr; }
}
function makeRng(seed){ return rng(seed); }
function pick(spec, rnd){
  if(!spec) throw new Error("Bad param spec");
  if(Array.isArray(spec.values)){ const a=spec.values; return a[Math.floor(rnd()*a.length)]; }
  const min=spec.min??0, max=spec.max??min, exclude=new Set(spec.exclude||[]);
  const isInt=Number.isInteger(min)&&Number.isInteger(max);
  for(let i=0;i<400;i++){
    const v=isInt?Math.floor(min+rnd()*(max-min+1)):(min+rnd()*(max-min));
    if(!exclude.has(v)) return v;
  }
  throw new Error("Could not sample param");
}
function fmtNumber(x){
  if (typeof x !== 'number') return x;
  // prefer nice fractions if they are simple repeating thirds / sixths? (lightweight)
  const r3 = Math.round(x*3)/3;
  if (Math.abs(x-r3) < 1e-10) return Number(r3.toFixed(3));
  // default 3 d.p. max
  return Number(x.toFixed(3));
}
function generateItem(tpl, seed="demo"){
  const rnd=makeRng(seed);
  const {stem, params={}, derived={}, constraints=[], answer, distractors=[]}=tpl;
  const MAX=250;
  for(let attempt=0;attempt<MAX;attempt++){
    const P={}; for(const[k,s] of Object.entries(params)) P[k]=pick(s,rnd);
    const D={}; let okDer=true; for(const[k,e] of Object.entries(derived)){ try{ D[k]=evalExpr(e,{...P,...D}); }catch{ okDer=false; break; } }
    if(!okDer) continue;
    let ok=true; for(const c of constraints){ try{ if(!evalExpr(c,{...P,...D})) { ok=false; break; } }catch{ ok=false; break; } }
    if(!ok) continue;
    let ans=safeEvalOrLiteral(answer,{...P,...D}); if(typeof ans==="number") ans=fmtNumber(ans);
    const opts=[];
    for(const d of distractors){
      let v=safeEvalOrLiteral(d,{...P,...D,ans}); if(typeof v==="number") v=fmtNumber(v);
      if(String(v)!==String(ans)) opts.push(v);
    }
    // Autopad to 3 distractors if numeric
    if(typeof ans==="number" && opts.length<3){
      const used=new Set([String(ans), ...opts.map(String)]);
      const mag=Math.max(1e-6, Math.pow(10, Math.floor(Math.log10(Math.abs(ans)||1))-1));
      const candidates=[ans+mag, ans-mag, Math.floor(ans), Math.ceil(ans), ans*1.1, ans*0.9];
      for(const c of candidates){ const v=fmtNumber(c); if(!used.has(String(v))){ opts.push(v); used.add(String(v)); if(opts.length>=3) break; } }
      while(opts.length<3){
        const delta=(0.5+rnd())*mag*(rnd()<0.5?-1:1);
        const v=fmtNumber(ans+delta); if(!used.has(String(v))){ opts.push(v); used.add(String(v)); }
      }
    }
    return { stem:renderStem(stem,{...P,...D}), answer:ans, distractors:opts.slice(0,3) };
  }
  throw new Error("Constraint not satisfiable");
}

/* ---------- data load ---------- */
async function loadAll(){
  const names=Object.keys(FILES);
  const buckets=[];
  for(const n of names){
    const r=await fetch(FILES[n],{cache:'no-store'});
    if(!r.ok) throw new Error('Load failed: '+n);
    buckets.push(await r.json());
  }
  return buckets.flat();
}

/* ---------- build module sets ---------- */
function seededShuffle(arr, seed){
  const r=makeRng(seed); const a=arr.slice();
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(r()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function takeByDifficulty(pool, mix, seed){
  const groups = {E:[],M:[],H:[]};
  for(const it of pool){ const d=(it.difficulty||'M').toUpperCase(); if(groups[d]) groups[d].push(it); }
  return [
    ...seededShuffle(groups.E, seed+":E").slice(0, mix.E||0),
    ...seededShuffle(groups.M, seed+":M").slice(0, mix.M||0),
    ...seededShuffle(groups.H, seed+":H").slice(0, mix.H||0),
  ];
}

/* ---------- state ---------- */
const state = {
  moduleNo: 1,
  itemsM1: [],
  itemsM2: [],
  answers: {},          // key: "1-idx" or "2-idx"
  review: {},           // marked for review
  cursor: 0,
  timer: MODULE_TIME_SECONDS,
  route: 'm1',
  seed: (new Date().toISOString().slice(0,10))
};

/* ---------- rendering ---------- */
function renderMath(container){
  if(window.renderMathInElement){
    window.renderMathInElement(container,{
      delimiters:[
        {left:"$$",right:"$$",display:true},
        {left:"\\[",right:"\\]",display:true},
        {left:"\\(",right:"\\)",display:false},
        {left:"$",right:"$",display:false}
      ],
      throwOnError:false
    });
  }
}
function renderProgress(){
  const total = (state.moduleNo===1? state.itemsM1.length : state.itemsM2.length) || 22;
  const answered = Object.keys(state.answers).filter(k=>k.startsWith(state.moduleNo+"-") && state.answers[k]!=null && state.answers[k]!=='' ).length;
  const pct = Math.round(100*answered/total);
  el.prog.style.width = pct+"%";
}
function renderQuestion(){
  const items = (state.moduleNo===1? state.itemsM1 : state.itemsM2);
  const item = items[state.cursor];
  el.qIndex.textContent = state.cursor+1;
  el.qTotal.textContent = items.length;
  el.modNo.textContent  = state.moduleNo;
  el.routeLabel.textContent = state.moduleNo===1? 'Module 1' : (state.route==='m2h'?'Module 2 (hard)':'Module 2 (easy)');

  el.stem.innerHTML = item.stem;
  renderMath(el.stem);

  el.choices.innerHTML = '';
  const opts = seededShuffle([item.answer, ...item.distractors], (state.seed+":"+state.moduleNo+":"+ (state.cursor+1) +":opts"));
  if (opts.length === 0){ // free response
    const wrap = document.createElement('div');
    wrap.className = 'free';
    wrap.innerHTML = `<label>Answer:</label><input id="freeInp" type="text" inputmode="decimal" autocomplete="off" />`;
    el.choices.appendChild(wrap);
    const key = `${state.moduleNo}-${state.cursor}`;
    const saved = state.answers[key] ?? '';
    document.getElementById('freeInp').value = saved;
    document.getElementById('freeInp').addEventListener('input', (e)=>{ state.answers[key] = e.target.value.trim(); renderProgress(); });
  } else {
    opts.forEach((o, i)=>{
      const id = `opt${i}`;
      const div = document.createElement('label');
      div.className = 'choice';
      div.innerHTML = `
        <input type="radio" name="opt" id="${id}" value="${o}">
        <div>${o}</div>
      `;
      el.choices.appendChild(div);
    });
    // restore
    const key = `${state.moduleNo}-${state.cursor}`;
    const saved = state.answers[key];
    if(saved!=null){
      [...el.choices.querySelectorAll('input[type=radio]')].forEach(r=>{
        if(String(r.value)===String(saved)) r.checked = true;
      });
    }
    el.choices.addEventListener('change', (e)=>{
      if(e.target && e.target.name==='opt'){
        state.answers[`${state.moduleNo}-${state.cursor}`] = e.target.value;
        renderProgress();
      }
    }, {once:true});
  }

  // mark for review toggle
  const mk = state.review[`${state.moduleNo}-${state.cursor}`] || false;
  el.mark.checked = mk;
  el.mark.oninput = () => { state.review[`${state.moduleNo}-${state.cursor}`] = el.mark.checked; };
}
function renderTimer(){
  const t = Math.max(0, state.timer);
  const m = Math.floor(t/60), s = t%60;
  el.timer.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ---------- navigation ---------- */
el.back.onclick = ()=>{
  if(state.cursor>0){ state.cursor--; renderQuestion(); }
};
el.next.onclick = ()=>{
  const items = (state.moduleNo===1? state.itemsM1 : state.itemsM2);
  if(state.cursor < items.length-1){
    state.cursor++; renderQuestion();
  }else{
    // End of module
    if(state.moduleNo===1){
      // route
      const correct = gradeModule(1).raw;
      state.route = (correct >= ROUTE_THRESHOLD) ? 'm2h' : 'm2e';
      startModule2();
    }else{
      // finished test -> show score
      const g1 = gradeModule(1), g2 = gradeModule(2);
      const total = g1.raw + g2.raw;
      alert(`Module 1: ${g1.raw}/${state.itemsM1.length}\nModule 2: ${g2.raw}/${state.itemsM2.length}\n\nTotal correct: ${total}/44`);
    }
  }
};

/* ---------- grading ---------- */
function gradeModule(n){
  const items = (n===1? state.itemsM1 : state.itemsM2);
  let raw = 0;
  items.forEach((it, idx)=>{
    const ans = state.answers[`${n}-${idx}`];
    if(ans==null || ans==='') return;
    if(String(ans)===String(it.answer)) raw++;
  });
  return {raw};
}

/* ---------- module lifecycle ---------- */
let tickHandle=null;
function startTimer(){
  stopTimer();
  state.timer = MODULE_TIME_SECONDS;
  renderTimer();
  tickHandle = setInterval(()=>{
    state.timer--;
    renderTimer();
    if(state.timer<=0){
      clearInterval(tickHandle);
      // auto-advance end of module
      if(state.moduleNo===1) {
        const correct = gradeModule(1).raw;
        state.route = (correct >= ROUTE_THRESHOLD) ? 'm2h' : 'm2e';
        startModule2();
      } else {
        const g1 = gradeModule(1), g2 = gradeModule(2);
        const total = g1.raw + g2.raw;
        alert(`Time!\n\nModule 1: ${g1.raw}/${state.itemsM1.length}\nModule 2: ${g2.raw}/${state.itemsM2.length}\n\nTotal correct: ${total}/44`);
      }
    }
  }, 1000);
}
function stopTimer(){ if(tickHandle) clearInterval(tickHandle); }

async function startModule1(){
  el.routeLabel.textContent = 'Module 1';
  state.moduleNo = 1;
  state.cursor = 0;

  const all = await loadAll();
  // stable but seeded
  const allShuf = seededShuffle(all, state.seed+":all");
  state.itemsM1 = takeByDifficulty(allShuf, MIX.m1, state.seed+":m1")
    .map((it, i)=> genVariant(it, "m1:"+it.id));

  el.qTotal.textContent = state.itemsM1.length;
  renderQuestion();
  renderProgress();
  startTimer();
}
function startModule2(){
  stopTimer();
  state.moduleNo = 2;
  state.cursor = 0;
  el.modNo.textContent = 2;

  el.routeLabel.textContent = (state.route==='m2h'?'Module 2 (hard)':'Module 2 (easy)');

  loadAll().then(all=>{
    const mix = (state.route==='m2h'? MIX.m2_hard : MIX.m2_easy);
    const pool = seededShuffle(all, state.seed+":m2pool");
    state.itemsM2 = takeByDifficulty(pool, mix, state.seed+":m2")
      .map((it,i)=> genVariant(it, "m2:"+it.id));
    el.qTotal.textContent = state.itemsM2.length;
    renderQuestion();
    renderProgress();
    startTimer();
  });
}

/* generate concrete variant now so we freeze params/answers */
function genVariant(item, seed){
  const g = generateItem(item.template, seed);
  return { id:item.id, stem:g.stem, answer:g.answer, distractors:g.distractors, difficulty:item.difficulty||'M' };
}

/* ---------- calculator + reference modals ---------- */
function show(elm){ elm.style.display='flex'; elm.setAttribute('aria-hidden','false'); }
function hide(elm){ elm.style.display='none'; elm.setAttribute('aria-hidden','true'); }

el.calcBtn.onclick = ()=> show(el.calcModal);
el.refBtn.onclick  = ()=> show(el.refModal);
el.closeCalc.onclick = ()=> hide(el.calcModal);
el.closeRef.onclick  = ()=> hide(el.refModal);
el.calcModal.addEventListener('click', e=>{ if(e.target===el.calcModal) hide(el.calcModal); });
el.refModal.addEventListener('click',  e=>{ if(e.target===el.refModal) hide(el.refModal); });
document.querySelectorAll('#calcModal .tab').forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll('#calcModal .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const which = btn.dataset.tab;
    document.getElementById('calcG').style.display = (which==='g')?'block':'none';
    document.getElementById('calcS').style.display = (which==='s')?'block':'none';
  };
});

/* ---------- boot ---------- */
function boot(){
  renderTimer();
  startModule1();
  // keyboard helpers
  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') el.next.click();
    if(e.key==='ArrowLeft')  el.back.click();
  });
}
boot();
</script>
</body>
</html>
